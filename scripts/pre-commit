#!/bin/sh

# This file will be used as .git/hooks/pre-commit .
# However, it should be edited as scripts/git-hook-pre-commit .

# Fail if any command fails
set -e

# In the commit hook, only check things that are quick and can be quickly fixed.

JAVA_VER=$(java -version 2>&1 | head -1 | cut -d'"' -f2 | sed '/^1\./s///' | cut -d'.' -f1) \
  && if [ "$JAVA_VER" != "8" ]; then
    ./gradlew spotlessCheck
  fi

make plume-scripts-update || true
# Under CI, there are two CPUs, but limit to 1 to avoid out-of-memory error.
if [ -n "$(./.plume-scripts/is-ci.sh)" ]; then
  num_jobs=1
else
  num_jobs="$(nproc || sysctl -n hw.ncpu || getconf _NPROCESSORS_ONLN || echo 1)"
fi
make -k style-check --jobs="${num_jobs}"
